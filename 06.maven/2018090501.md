# Chap 11 빌드 프로파일

## 빌드 프로파일의 역할 
프로파일은 각각의 다른 환경에 맞는 각 빌드를 커스터마이즈 할 수 있는 기능을 제공한다. 즉 프로파일은 다른 빌드 환경간에 이식성을 제공한다.  
다른 빌드 환경의 두 가지 측면은 제품화 환경과 개발 환경이다.


설정을 빌드 환경에 따라 재정의할 수 있도록 구성할 수 있는데, 메이븐 프로파일 설정에 대해 이야기하기 전에 빌드 이식성의 개념에 대해 정의한다.


**빌드 이식성이란?**

 빌드의 이식성이란 각 프로젝트 및 빌드를 다른 환경에 맞게 얼마나 쉽게 구축할 수 있는가를 측정하는 것이다.   
대부분의 이식성을 갖춘 프로젝트는 빌드를 바로바로 처리할 수 있도록 빌드 툴을 플랫폼에 따라 설정하여 이식성에 관한 어려운 설정을 해결하고 있다.

빌드의 이식성을 어떻게 부여하는지 확인하기 전에, 이식성의 다른 측면에 대해 알아본다.



* 이식성 없는 빌드

메이븐과 같이 이식성이 없는 프로젝트도 있다. 일반적으로는 비이식성을 피하는 것이 좋다. 비이식적인 빌드는 하나의 장비에서만 돌아가는 일회용품과 같다.   
메이븐은 프로파일을 사용하여 빌드를 커스터마이즈할 수 있도록 제공하고 있다.


* 환경적인 이식성
빌드의 환경적 이식성이란 다른 환경에 맞도록 커스터마이즈된 기능과 설정을 위한 메커니즘을 제공하는 것이다. 예를 들어 하나의 프로젝트가 테스트 DB와 제품화 DB 를 참조한다면 환경적인 이식성이다.  
이는 빌드가 각 환경에 맞는 다른 프로퍼티들을 가지고 있는 것과 같다. 


* 조직적인(내부) 이식성

보안과 같은 문제로 어떤 조직의 내부에서만 이식이 되어야 하는 경우, 단일 조직에서 이식성을 가진 교차 환경을 지원해야 한다.


* 전역적인 이식성

누구라도 특정한 환경을 위한 빌드를 커스텀할 필요없이 광범위한 프로젝트의 소스를 다운로드하고 컴파일하고 인스톨할 수 있는 것.




**이식성의 적정 단계 선택**

비이식적인 빌드를 하게 된다면 조직에서는 특별한 개인적인 도움 없이는 애플리케이션을 특정 장비에 디플로이 할 수 없을 것이다.

이식성이 높은 빌드는 프로젝트에서의 기여도를 높인다. 이식성이 높은 프로젝트는 최종 사용자가 개발자가 되기 위해 거추장스러운 빌드 절차를 따라하지 않아도 그저 소스를 다운로드하고 변경하고 빌드하고 제출하여 쉽게 빌드 환경을 구성할 수 있다.


## 메이븐 프로파일을 이용한 이식성

메이븐 프로파일은 기본값들을 재정의 하거나 설정값들을 정의하는 것에 대한 대안이다. 프로파일을 사용하여 다른 환경을 위해 빌드를 커스터마이즈할 수 있다.  
프로파일은 pom.xml에 구성되며 식별자가 주어진다.



~~~
<profiles> //pom 내의 기본설정을 재정의하며, 보통 pom 마지막에 존재
	<profile>
		<id>production</id> //각 프로파일은 id 엘리먼트를 가진다. 이 엘리먼트는 명령행에서 이 프로파일을 호출할 때 사용하는 이름이다.
		<build> 
			<plugins>
				<plugin>
					<groupId></groupId>
					<artifactId></artifactId>
					<configuration>
						<debug>false</debug> //Compiler 플러그인의 설정 재정의. production 프로파일은 디버그 정보를 포함하지 않고 바이트코드는 컴파일러 최적화 루틴을 통해 생성되도록 만들었다
						<optimize>true</optimize>
					<configuration>
				</plugin>
			</plugins>
		</build>

	</profile>
</profiles>


~~~


**POM 재정의**

메이븐 프로파일에서는 무엇이 재정의될 수 있을까?

pom내부의 거의 대부분을 재정의할 수 있으며, POM에 포함된 <profiles>를 통해 프로파일에 맞는 설정을 할 수 있다.   
각 프로파일은 반드시 <id>를 가져야하며, 대부분의 엘리먼트를 포함한다.

<profiles>에서 허용된 엘리먼트들

~~~

<project>
    <profiles>
        <profile>
            <build>
                <defaultGoal>...</defaultGoal>
                <finalName>...</finalName>
                <resources>...</resources>
                <testResources>...</testResources>
                <plugins>...</plugins>
            </build>

            <reporting>...</reporting>
            <modules>...</modules>
            <dependencies>...</dependencies>
            <dependencyManagement>...</dependencyManagement>
            <distributionManagement>...</distributionManagement>
            <repositories>...</repositories>
            <pluginRepositories>...</pluginRepositories>
            <properties/>
        </profile>
    </profiles>
</project>


~~~

프로파일은 ...의 엘리먼트를 재정의할 수 있다.  
프로파일 내의 프로젝트 아티팩트의 최종 이름과 디펜던시, 그리고 플러그인 설정을 통한 프로젝트 빌드 기능을 재정의 할 수 있다.  
프로파일에 의존된 배포 설정을 재정의 할 수 있다.

예를 들어 staging 서버에 아티팩트를 배포할 필요가 있다면, staging 프로파일을 생성하고 프로파일 내의 <distributionManagement>...</distributionManagement>를 재정의하면 된다.






## 프로파일 활성화

운영체제나 JDK 버전과 같이 환경에 따라 프로파일을 적용할 필요가 있을때, 환경적 매개 변수에 따라 프로파일을 활성화 시키는 것을 프로파일 활성화라고 한다.


예를 들어 어떤 다중 모듈 프로젝트를 실행할때, 자바 5에서는 서브 모듈1을 빌드에 포함하지 않고, 자바 6에서는 서브 모듈1을 빌드에 포함하고 싶다고 하자

~~~

    <profiles>
        <profile>
            <id>jdk16</id>
            <activation>
                <jdk>1.6</jdk>
            </activation>
            <modules>
                <module>자바 6에서 활성화시킬 모듈명</module>
            </modules>
        </profile>
    </profiles>



~~~

<activation> 요소는 프로파일 활성화를 위한 조건을 나열한다. 예제는 자바가 1.6일때 프로파일이 활성화되도록 설정되었다. 


**활성화 설정**


활성화는 포함된 jdk 버전, 운영체제 매개변수, 파일, 그리고 프로퍼티와 같은 하나 이상의 선택자들을 포함하고 있다.   
프로파일은 모든 활성 기준들이 충족되었을때 활성화된다.  
예를 들어 윈도우 계열의 운영체제와 jdk1.4가 조건이라면, 윈도우 장비에 자바 4가 실행되어야만 프로파일이 활성화되어 빌드가 실행된다.   
만약 프로파일이 활성화된다면 명령행에서 -P를 주어 프로파일을 활성화 시키는 것처럼 모든 엘리먼트들이 재정의된다. 

~~~


    <profiles>
        <profile>
            <id>dev</id>
            <activation>
                <activeByDefault>false</activeByDefault> //이 프로파일이 기본적으로 활성화 될 것인지 
                <jdk>1.5</jdk> //자바 5에서 이 프로파일이 활성화됨
                <os>
                    <name>Windows Xp</name> //이 ㅍ로파일은 32비트플랫폼을 사용하는 윈도우 xp 5.1.2600 버전을 타깃으로 한다. 
                    <family>Windows</family>
                    <arch>x86</arch>
                    <version>5.1.26000</version
                </os>
                <property> //mavenVersion의 값이 2.0.5로 설정되었을 때 이프로파일을 활성화할 수 있도록 설정되어있다.
                    <name>mavenVersion</name>
                    <value>2.0.5</value>
                </property>
                <file> // 있거나 없는 파일들을 기반으로 프로파일을 활성화할 수 있다. file2.p~ 가 최상위 디렉토리에 있고, file1.p~가 최상위 디렉토리에 없으면 활성화된다
                    <exists>file2.properties</exists>
                    <missing>file1.properties</missing>
                </file>
            </activation>
        </profile>
    </profiles>


~~~



**프로퍼티 없는 활성화**


environment.type과 같은 프로퍼티의 값을 바탕으로 프로파일을 활성화할 수 있다.   
만약 environment.type 이 dev와 같으면 development 프로파일을 활성화시키고, prod와 같으면 production 프로파일을 활성화 시킬수있다.   
또한 프로퍼티 없이 프로파일을 활성화시킬수있다.


프로퍼티 없는 프로파일의 활성화

~~~

    <profiles>
        <profile>
            <id>development</id>
            <activation>
                 <property>
			<name>!environment.type</name> // ${environment.type} 프로퍼티가 설정되지 않았을때 활성화되는 프로퍼티
		 </property>
            </activation>
        </profile>
    </profiles>

~~~


## 외부 프로파일들 

이러한 프로파일들은 pom 밖으로 분리할 수 있다. 베이스 디렉토리에 profiles.xml을 위치시키고 <profiles> 엘리먼트를 추가하고 메이븐을 실행하면 된다.

## 프로파일 설정

프로젝트 프로파일은 특정 프로젝트의 설정을 재정의 할 때 사용한다.   
설정 프로파일은 메이븐을 통해 빌드하는 모든 프로젝트들에 적용된다.

설정 파일은 두 곳에서 위치할 수 있다. 사용자 정의 설정 프로파일은 .m2/settings.xml 에 정의하며, 모든 빌드시 사용되는 사용자 정의 설정 프로퍼티를 정의한 설정 프로퍼티를 정의할 수 있다.  
전역 설정 프로파일은 ${M2_HOME}/conf/settings.xml에 정의한다

...

**전역적인 설정 프로파일**

설정 프로파일처럼,  ${M2_HOME}/conf/settings.xml의 전역적인 프로파일을 정의할 수 있다. 이 설정 파일에 정의된 프로파일은 동일한 메이븐을 설치하여 사용하는 모든 사용자가 이용할 수 "없다"  
만약 특별한 조직을 위하여 커스터마이즈된 메이븐 배포본을 생성하고 모든 사용자가 내부적인 이식성을 보장하기 위하여 빌드 프로파일을 사용하기를 원한다면 전역적인 설정 프로파일을 사용하는 것이 유용하다.

특정 조직에서만 사용되는 커스텀 플러그인 저장소를 추가하거나 커스텀 플러그인들을 정의할 필요가 있다면, 이러한 설정을 "내장"한 메이븐 복사본을 사용자들에게 배포할 수 있다.  
전여적인 설정 프로파일의 정의는 사용자 정의 프로파일 설정과 같다.


## 활성화된 프로파일 목록

메이븐 프로파일은 pom.xml, profiles.xml, .m2/settings.xml, ${M2_HOME}/conf/settings.xml 에 정의할 수 있다.   
따라서 4가지 정의 방법 중 각 프로젝트에 적합한 프로파일을 일관되게 적용할 필요가 있다.

이미 정의한 사용가능한 프로파일들을 최대한 일관성 있게 관리하려면 메이븐 help 플러그인에 정의된 active-profiles 란 goal을 사용하면 활성 프로파일들과 어디에 정의되어 있는지를 알려준다

~~~
$ mvn help:active-profiles
~~~


## 팁과 트릭

프로파일은 빌드 이식성을 촉진할 수 있다. 만일 빌드시 다른 프랫폼을 위한 작업을 추가하거나, 다른 플랫폼에 맞는 빌드가 필요하다면, 프로젝트 프로파일은 빌드 이식성을 증가시킨다.  
설정 프로파일은 일반적으로 여러 개발자에게 반드시 전달되어야 하는 추가적인 프로젝트 정보가 더해져서 빌드 이식성이 감소한다.   

**공통환경**

메이븐 프로젝트 프로파일의 핵심 동기 중 하나는 특정 환경을 위한 설정을 제공하는 것이다. 예를 들어 개발 환경과 제품화 환경에서 보고 싶은 정보가 다를 것이다.  
앞서 dev 와 prod 같은 식별자로 여러 환경을 정의하였는데, 더 간단한 방법은 환경 프로퍼티에 의하여 활성화되는 프로파일을 정의하는 것이다.  
그리고 모든 프로젝트에서 공통 환경 프로퍼티를 사용할 수 있다.  
예를 들어 모든 프로젝트가 dev란 값을 가진 environment.type 프로퍼티에 의해 활성화되는 development 프로파일 & prod라는 값을 가진 environment.type 프로퍼티에 의해 활성화되는 제품화 프로파일을 가졌다고 하자.  
해당 프로젝트는 개발장비에선 항상 environment.type을 dev로 설정할 수 있도록 settings.xml에 기본 프로파일을 설정할 수 있다.   

설정은 메이븐 296~7 페이지 참고


개발자가 정의한 몇 가지 프로퍼티는 pom.xml 내에 설정된 다른 메이븐 플러그에서 사용할 수 있다. (Db를 조작하거나 sql을 실행시키는 등) 반대로, 이러한 플러그인들은 앞의 프로퍼티들을 사용하여 pom.xml 내에 설정할수도 있다.



**기밀사항 보호**

대규모 조직에서 애플리케이션을 개발한다면 상용 데이터베이스의 pw와 같은 기밀사항을 새발 그룹에서 알지못하도록 하는 것이 중요하다. 조직적으로 개발과 운영 그룹을 구분하는 것이 전형적이다.  
개발자들은 개발과 스테이징 환경에 접근할 수 있지만, 상용 DB 에는 접근할 수 없다.   
이럴때 제품화환경을 위한 빌드는 특수한 소수만이 처리를 하게 된다. 따라서 prod environment.type을 사용하여 이 빌드를 실행할 때는 settings.xml의 변수를 정의할 필요가 있다.

~~~

<settings>
    <profiles>
        <profile>
            <activeByDefault>true</activeByDefault>
            <properties>
                <environment.type>prod</environment.type>
                <database.password> 비밀번호~ </database.password>
            </properties>
        </profile>
    </profiles>
</settings>

~~~
사용자 정의 설정 프로파일에 기밀을 저장..  
environment.type을 prod로 설정하고, 또한 상용 암호 설정을 기본 프로파일에 정의 하였다. 따라서 프로젝트가 실행되었을 때 environment.type 프로퍼티와 database.password 프로퍼티가 설정되어야 제품화 프로파일이 활성화 된다. 

이런식으로 프로젝트의 pom.xml에 제품화 설정을 모두 정의할 수 있으나 상용 DB에 접근하기 위해필요한 패스워드같은 기밀 사항은 빼야한다. 

**플랫폼 분류자**

라이브러리나 프로젝트는 특정 플랫폼에 맞게 생산되어야 한다. JVM을 쓰는 자바도 특정 플랫폼에 종속적인 약간의 코드가 필요할 때가 있다.  
이럴 때 메이븐 Assembly 플러그인이나 메이븐 jar 플러그인으로 분류자를 설정할 수 있다.

다만 분류자를 설정하면서 코드가 중복될 수 있으므로 변수 대입을 사용한다.

책 301 페이지 참고 
