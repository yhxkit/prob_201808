<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pilot</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdn.ckeditor.com/4.10.1/standard/ckeditor.js"></script>
    
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
   
    <style type="text/css">

        /* The Modal (background) */
        #joinModal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        #joinDiv {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 50%; /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        #joinModalClose {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        #joinModalClose:hover,
        #joinModalClose:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }


	#wrap{
		margin-left: auto;
		margin-right: auto;
		width: 90%
	}
	
	

	#header{
		margin-left: 5%;
		margin-right: 5%;
	}
	
	#postDetail{
		margin-left: auto;
		margin-right: auto;
		width: 85%
		}
	

    </style>
    <script type="text/javascript">

        var postNumPerPage=2;
        var pageNumPerPage=3;
        var currentUserToken;
        var currentUserEmail;
        var currentUserScope;

        window.onload=function(){
            CKEDITOR.replace( 'postContent' ); //postWriteForm Editor activating
            CKEDITOR.replace( 'postEditContent' );
            CKEDITOR.replace( 'commentContent', {
                height: 100
            } );

            currentUserToken = sessionStorage.getItem("currentUserToken");
            currentUserEmail = sessionStorage.getItem("currentUserEmail");
            currentUserScope = sessionStorage.getItem("currentUserScope")

            console.log("현재 로그인 된 이용자의 토큰! "+currentUserToken);
            console.log("현재 로그인 된 이용자의 메일! "+currentUserEmail);
            console.log("현재 로그인 된 이용자의 권한! "+currentUserScope);


            if(currentUserToken==null){
                document.getElementById('logout').style.display='none';
                document.getElementById('login').style.display='block';
            }else{
                $('#currentUserEmail').text(currentUserEmail);
                document.getElementById('login').style.display='none';
                document.getElementById('logout').style.display='block';


                var tabs ='<li role="presentation" class="active"><a href="">BBS</a></li>'
                    +'<li role="presentation"><a >MyPage</a></li>';

                if(currentUserScope=='ADMIN'){
                     tabs += '<li role="presentation"><a onclick="javascript: toUserList(1)">Users</a></li>'


                     + '  <div class="row" id="userSearchInput" hidden>'
                     + ' <div class="col-lg-3 col-md-3">'
                    + ' <div class="input-group">'
                    + '   <input type="text" class="form-control" placeholder="Search user" id="userSearchKeyword">'
                    + '    <span class="input-group-btn">'
                    + '   <button class="btn btn-default" type="button" onclick="javascript:searchUser(1)">검색</button>'
                    + ' </span>'
                         + '   </div>'
                         + '   </div>'
                    + '   </div>';

					}
                document.getElementById('navForAdmin').innerHTML = tabs;

            }
            bbs(1);


            //상세 화면
            document.getElementById('detailPage').style.display='none';
            //리스트에서 상세 클릭시 보이기..


            //글쓰기 화면
           var writeAPost =   document.getElementById('postWrite');
            writeAPost.style.display='none';
         

            $(document).on('click', '#toPostWriteForm', function (event) {
                event.preventDefault();
                writeAPost.style.display = "block";
                document.getElementById('detailPage').style.display = "none";
                document.getElementById('bbs').style.display='none'; //이거 왜 변수로 빼면 안먹히는걸까..? 펑션 내부 항목을 포함하고 있어서?

            });





            //joinModal 관련
            var joinModal = document.getElementById('joinModal');
            joinModal.style.display='none';
            $(document).on('click', '#toJoinForm', function (event) {
                event.preventDefault();
                joinModal.style.display = "block";
            });

            //modal x 클릭시 닫음
            var joinModalClose = document.getElementById('joinModalClose');
            joinModalClose.onclick=function(){
                joinModal.style.display = "none";
            };

            //modal 외부 클릭시 닫음
            window.onclick = function(event) {
                if (event.target == joinModal) {
                    joinModal.style.display = "none";
                }
            };


        }; //window.onload  ends

		//코멘트 수정
	/* 	var showCommentEdit=true;
       $(document).on('click', '#editComment', function(event){
    	   	event.preventDefault();
    	   	console.log("코멘트 수정 클릭!");
       	 
    	   	if(showCommentEdit){
    	   		// 수정폼을 보여주는데, 수정의 앞에 있는 노드로 잡아서 보여주면...되지 않을까?

        	   	this.nextElementSibling.nextElementSibling.nextElementSibling.innerHTML="여기다 수정폼붙이";
    	   	}else{
    	   		
    	   	}

    	   	showCommentEdit = !showCommentEdit;
       }); */


        //포스트 수정...수정 html 에서 하려면 ACKEDITOR 때문에 홈에서..
        var showPostEdit=true;
        $(document).on('click',  '#editPost', function (event) {
            event.preventDefault();
            if (showPostEdit) {
                $('#postDetail input').attr('type', 'text');
                $('#postDetail div').show();
                $('.detail').hide();
            } else {
                $('#postDetail input').attr('type', 'hidden');
                $('#postDetail div').hide();
                $('.detail').show();
                editPost();
            }
            showPostEdit = !showPostEdit;
        });


        function editPost() {
            var editingPostIdx = $('#postDetail #postIdxSpan').val();
            var editingPostData = JSON.stringify({
                'postIdx': editingPostIdx,
                'title': $('#postDetail #title').val(),
                'postContent': CKEDITOR.instances.postEditContent.getData()
            });
            console.log("수정된 포스트 "+editingPostData);

            $.ajax({
                url: 'http://localhost:8080/bbs/'+ editingPostIdx,
                type: 'put',
                headers: {'token': sessionStorage.getItem('currentUserToken')},
                data: editingPostData,
                contentType: 'application/json; charset=utf-8',
                success: function(data){
                    alert("수정 성공..");
                   // window.location.reload();
                   showDetail(editingPostIdx);

                },
                error: function(data){
                    alert(" 등록 실패 : "+data['responseJSON']['message']);
                    window.location.reload();
                }
            });

        }

    

        function bbs(currentPage){
            //bbs 목록
            var listObj = "";
            $.getJSON('http://localhost:8080/bbs?page='+currentPage+'&elementsNumberForOnePage='+postNumPerPage, function (data) {
                $(data['posts']).each(function (num, ele) {//첫번째 인자가 인덱스, 두번째 인자가 엘리먼트
                
                    listObj += '<tr style="cursor:pointer;" onclick="javascript:showDetail('+ele.postIdx+')" onmouseover="this.style.backgroundColor=\'#f1f1f1\'" onmouseout="this.style.backgroundColor=\'#ffffff\'"'
                        +'><td hidden="hidden">' + ele.postIdx + '</td>'
                        + '<td>' + ele.title
                        + '</td><td>'
                        + ele.postWriter.email + '</td>'
                        + '<td>' + ele.postTime + '</td></tr>';
                });

                $('#bbsTable tbody').eq(1).html(listObj);


                console.log("현재 페이지"+currentPage);

                //bbs 페이지네이션
                console.log('토탈 포스트'+ data['totalPost']);
                var totalPost = data['totalPost'];
                var totalPage = parseInt(totalPost/postNumPerPage);
                if (totalPost%postNumPerPage!=0){totalPage = totalPage+1;}

                var startPage =1;
                if(currentPage>pageNumPerPage){
                	startPage= currentPage-(currentPage%pageNumPerPage)+1;
                	if(currentPage%pageNumPerPage==0){startPage=currentPage-pageNumPerPage+1;}	
                }

                var endPage = startPage+pageNumPerPage-1;
                if(endPage>=totalPage){endPage=totalPage;}
			  
                console.log('토탈 페이지 '+totalPage);

                var pagingObj="";
                
                if(startPage!=1){
                    pagingObj+='<li><a style="cursor:pointer;" onclick="javascript:bbs('+(startPage-1)+')" aria-label="Previous">  <span aria-hidden="true">&laquo;</span> </a></li>';
                }

                for(var i=startPage; i<=endPage; i++){
                    if(i==currentPage){
                        pagingObj+='<li><a>'+i+'</a></li>';
                    }else{
                        pagingObj+='<li><a style="cursor:pointer;" onclick="javascript:bbs('+i+')">'+i+'</a></li>';
                    }
                }
                if(endPage != totalPage){
                    pagingObj+='<li><a style="cursor:pointer;" onclick="javascript:bbs('+(endPage+1)+')" aria-label="Next"><span aria-hidden="true">&raquo;</span> </a></li>';
                }

                $('#paging ul').eq(0).html(pagingObj);

            });

        } // showing bbs list end



        function emailCheck(str){
            var regExp = /[0-9a-zA-Z][_0-9a-zA-Z-]*@[_0-9a-zA-Z-]+(\.[_0-9a-zA-Z-]+){1,2}$/; //여기 백하고 밸리데이션 맞춰야함;
            if (!str.match(regExp)){return false;}
            return true;
        }


    </script>
</head>
<body>
<div id="wrap" >

<!-- <div class="navbar  navbar-fixed-top" style="background-color:white;  "> -->
<div  id="navs">
<div class="container-fluid" id="header" style="vertical-align: middle">

	<div class= "navbar-left" style="display: inline-block" >
		<ul class="nav nav-tabs"  id="navForAdmin">
		</ul>
	</div>

	<div class= "navbar-right">
	    <div id="login" th:include="header/login"></div>
		<div id="logout" th:include="header/logout"></div>
	</div>
</div>
</div>	

	
	
	<div id="joinModal" th:include="header/join"></div>
	
<div class="container-fluid" id="bbsRelated">
	
	<div id="detailPage">
	    <div id="postDetailPage" th:include="bbs/detail"></div>
	    <div id="commentList" th:include="bbs/commentList"></div>
	    <div id="commentWrite" th:include="bbs/commentWrite"></div>
	</div>
	
	
	<div id="postWrite" th:include="bbs/write"></div>
	
	
	<div id="bbs" >
	    <table id="bbsTable" class="table">
	        <tr>
	            <th>제목</th><th>글쓴이</th><th>작성시간</th>
	        </tr>
	        <tbody></tbody>
	    </table>
	
	
	    <div id="paging" class="text-center">
	        <ul  class="pagination"></ul>
	    </div>
	
	 <div class=" text-right">
	    <a  class="glyphicon glyphicon-plus " id="toPostWriteForm">글쓰기..</a>
	 </div>
	</div>

	</div>

	<div class="container-fluid">
		<div id="adminPage" hidden>
			<div id="userListPage" th:include="adminPage/userList"></div>
		</div>
	</div>


	
	</div>
</body>
</html>