<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>userList</title>
    <script type="text/javascript">


        function searchUser(currentUserSearchPage){
            console.log("검색어 "+$('#userSearchKeyword').val());
            var keyword =  JSON.stringify({"email" : $('#userSearchKeyword').val()});
            console.log("보내는 데이터 "+keyword);

            $.ajax({
                type: 'Post',
                url: 'http://localhost:8080/admin/search?page='+currentUserSearchPage+'&elementsNumberForOnePage='+postNumPerPage,
                headers: {'token': localStorage.getItem('currentUserToken')},
                contentType: 'application/json; charset=utf-8',
                data: keyword,
                success: function (data) {
                    console.log("유저 리스트를 가져옴..."+JSON.stringify(data));
                    var userListObj = "";
                    $(data['users']).each(function (num, ele) {//첫번째 인자가 인덱스, 두번째 인자가 엘리먼트

                        userListObj +='<tr><td >'
                            +ele.email+'</td><td>'
                            +ele.name+'</td><td>'
                            +ele.status+'</td><td>'
                            +ele.auth+'</td><td>'
                            +ele.accountCreatedTime +'</td>' +
                            '<td style="cursor:pointer" onclick="javascript:changeUserStatus(\''+ele.email+'\')" class="glyphicon glyphicon-refresh"> 상태변경</td></tr>';
                    });

                    $('#userListTable tbody').eq(1).html(userListObj);

                    paginate(currentUserSearchPage, "javascript:searchUser", data, '#userListPaging ul', data['totalUser']); //검색은 서버에서 totalUser를 안넘겨서 페이지네이션 깨질것..


                },
                error: function (data) {
                    // alert("유저 리스트 로딩 실패ㅠㅠ"+data['responseJSON']['message'] + JSON.stringify(data));
                    // if(data['responseJSON']['status']==401){ //세션 만료 등으로 로그인이 무효
                    //     logout();
                    // }
                    // window.location.reload();
                    errorHandling(data);
                },
                complete: function (data) {
                    $('#userSearchKeyword').val('');
                }
            });

         }

        function toUserList(currentAdminPage){
           $.ajax({
                type: 'Get',
                url: 'http://localhost:8080/admin?page='+currentAdminPage+'&elementsNumberForOnePage='+postNumPerPage,
                headers: {'token': localStorage.getItem('currentUserToken')},
                success: function (data) {
                    console.log("관리자 유저 리스트를 가져오는데 성공."+JSON.stringify(data));

                   $('#adminPage').show();
                    $('#userSearchInput').show();
                    $('#postSearchInput').hide();
                    $('#bbsRelated').hide();
                    $('#navBbs').removeAttr("class")
                    $('#navUsers').attr('class', 'active');

                    var userListObj = "";
                    $(data['content']).each(function (num, ele) {//첫번째 인자가 인덱스, 두번째 인자가 엘리먼트

                                userListObj +='<tr><td >'
                                    +ele.email+'</td><td>'
                                    +ele.name+'</td><td>'
                                    +ele.accountCreatedTime+'</td><td>'
                                    +ele.auth+'</td><td>'
                                    +ele.status +'</td>' +
                                    '<td style="cursor:pointer" onclick="javascript:changeUserStatus(\''+ele.email+'\')" class="glyphicon glyphicon-refresh"> 상태변경</td></tr>';
                       });

                        $('#userListTable tbody').eq(1).html(userListObj);

                          paginate(currentAdminPage, "javascript:toUserList", data, '#userListPaging ul', data['totalElements']);
                },
                error: function (data) {
                    errorHandling(data);
                },
                complete: function (data) {
                }
            });

        } //totalUserList ends


        function changeUserStatus(userEmail) {

            var send =  JSON.stringify({"email" : userEmail});
            console.log("보내는 데이터 "+send);
            $.ajax({
                type: 'Put',
                url: 'http://localhost:8080/admin/'+userEmail,
                data: send,
                headers: {'token': localStorage.getItem('currentUserToken')},
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    console.log("유저상태 변경 성공");
                    toUserList(1);
                },
                error: function(data){
                    errorHandling(data);
                }

            });
        }




    </script>
</head>
<body>

    <div id="userList">
        <table id="userListTable" class="table">
            <tr>
                <th>유저</th><th>이름</th><th>생성일</th><th>권한</th><th>상태</th><th>상태 변경</th>
            </tr>
            <tbody></tbody>
        </table>


        <div id="userListPaging" class="text-center">
            <ul  class="pagination"></ul>
        </div>

    </div>
</body>
</html>