<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LoginForm</title>

    <script type="text/javascript">

        $(document).on('click', '#loginForm #loginButton', function (event) {
            event.preventDefault();
            var email = document.getElementById('loginEmail').value;
            var password = document.getElementById('loginPassword').value;
            console.log(email, password);

            if(email.trim() == "" || password.trim() == ""){
                $('#loginError').html("<p style='color: red'>이메일과 패스워드를 입력해주세요</p>");
            }else{
               signIn(email);
            }
        });

        function signIn(email){
            var loginData= $('#loginForm').serialize();

            console.log(loginData);
            $.post('login', loginData, function () {

            }).done(function (data, textStatus, request) {
                console.log(email+" 로그인 성공 "+request.getAllResponseHeaders());
                sessionStorage.removeItem("currentUserToken");
                sessionStorage.removeItem("currentUserEmail");
                sessionStorage.removeItem("currentUserScope")
                sessionStorage.setItem("currentUserToken", request.getResponseHeader("Authorization"));
                sessionStorage.setItem("currentUserEmail", email);


                var parsingStr =sessionStorage.getItem("currentUserToken");
                // var regExp = /[0-9a-zA-Z][_0-9a-zA-Z-]+[.][0-9a-zA-Z][_0-9a-zA-Z-]+[.][0-9a-zA-Z][_0-9a-zA-Z-]/;
                // if (parsingStr.match(regExp)){
                //     var getval = parsingStr.match(/[.](.*?)[.]/);
                //     console.log("가져온 값 "+getval); //왜 이렇게 나오지..?

                var startTo = parsingStr.indexOf(".", 0);
                var removeHeader = parsingStr.substring((startTo+1));
                var endfrom = removeHeader.indexOf(".", 0);
                var result = removeHeader.substring(0, endfrom);
                console.log("얻은 토큰"+result);
                var decodeScope = window.atob(result);
                decodeScope = JSON.parse(decodeScope);
                var userScope = decodeScope.scope;

                if(userScope == 'ADMIN'){//ADMIN으로 해야하는데 일단 유저로..
                    sessionStorage.setItem("currentUserScope", 'ADMIN');
                }
              window.location.reload();

            }).fail(function (data) {
                alert("로그인 실패ㅠㅠ" + JSON.stringify(data));
                $('#loginError').html("<p style='color: red'>"+data['responseJSON']['message']+"</p>");
            });
        }



    </script>
</head>
<body>

<div id="loginDiv">

    <form id="loginForm"  class="navbar-form">
        <input type="email" id="loginEmail" name="email" placeholder="이메일">
        <br/>
        <input type="password" id="loginPassword" name="password" placeholder="비번">
        <br/>
        <button id="loginButton" type="submit">로그인 하기 </button>
         <button type="button" id="toJoinForm" >회원 가입</button>
    </form>
    <div id="loginError"></div>
</div>
   

</body>
</html>